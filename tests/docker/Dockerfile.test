# ======================================================================
# Rxiv-Maker Installation Testing Dockerfile
# ======================================================================
# This Dockerfile creates a clean Ubuntu environment for testing
# the Universal Python Wheel Installer functionality.
# ======================================================================

FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
ENV PYTHONUNBUFFERED=1

# Install system dependencies for testing
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Python 3.11 and essential tools
    python3.11 \
    python3.11-venv \
    python3.11-dev \
    python3-pip \
    python3-setuptools \
    python3-wheel \
    # Build tools
    build-essential \
    make \
    pkg-config \
    # Network tools
    curl \
    wget \
    ca-certificates \
    # Version control
    git \
    # Testing utilities
    file \
    # Clean up
    && rm -rf /var/lib/apt/lists/*

# Set Python 3.11 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1

# Upgrade pip and install build tools
RUN python3 -m pip install --no-cache-dir --upgrade pip setuptools wheel build

# Install Docker for container-in-container testing if needed
RUN curl -fsSL https://get.docker.com -o get-docker.sh && \
    sh get-docker.sh && \
    rm get-docker.sh

# Create test user (but default to root for testing)
RUN useradd -m -s /bin/bash tester && \
    usermod -aG sudo tester

# Set working directory
WORKDIR /test

# Copy test requirements
COPY requirements-test.txt /test/requirements-test.txt

# Install test dependencies
RUN pip install --no-cache-dir -r requirements-test.txt

# Default command
CMD ["/bin/bash"]
